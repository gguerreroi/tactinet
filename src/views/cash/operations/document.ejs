<%
    function badge_status(estado){
        if (estado === 'RV')
            return `<span class="badge badge-danger ">Anulado</span>`

        return `<span class="badge badge-primary ">Aplicado</span>`
    }
var doc = document != undefined ? document : {};

var encabezado = doc.codoperador == "8" ? {
    stragencia: "ELECTROTEL",
    strempresa: "COMINSA, SOCIEDAD ANONIMA",
    strnit: "28163273",
    stractividad: "Servicio de Internet Residencial",
    strdireccion: "6 Avenida 1-70 Zona 4 Tactic A. V.",
    strtelefono: "3667-3866",
    strhorario_sem: "09:00am - 05:30pm",
    strhorario_fs: "09:00am - 01:00pm"
} : {
    stragencia: "SONIVISION",
    strempresa: "Jose Antonio Guerrero",
    strnit: "3563626",
    stractividad: "Servicio de television por cable",
    strdireccion: "1 Calle 4-69 Zona 4 Tactic A. V.",
    strtelefono: "79539140",
    strhorario_sem: "08:30am - 01:00pm y 02:00pm - 05:30pm",
    strhorario_fs: "08:30am - 02:30pm"
};
%>
<!DOCTYPE html>
<html lang="en">
<!--begin::Head-->
<head>
    <%- include('../../components/web-header') %>
</head>
<!--end::Head-->
<!--begin::Body-->
<body id="kt_body"
      class="header-fixed header-tablet-and-mobile-fixed toolbar-enabled toolbar-fixed toolbar-tablet-and-mobile-fixed aside-enabled aside-fixed"
      style="--kt-toolbar-height:55px;--kt-toolbar-height-tablet-and-mobile:55px">
<!--begin::Main-->
<!--begin::Root-->
<div class="d-flex flex-column flex-root">
    <!--begin::Page-->
    <div class="page d-flex flex-row flex-column-fluid">
        <%- include('../../components/left-aside.ejs') %>
        <!--begin::Wrapper-->
        <div class="wrapper d-flex flex-column flex-row-fluid" id="kt_wrapper">
            <!--begin::Header-->
            <div id="kt_header" class="header align-items-stretch">
                <!--begin::Container-->
                <div class="container-fluid d-flex align-items-stretch justify-content-between">
                    <!--begin::Aside mobile toggle-->
                    <div class="d-flex align-items-center d-lg-none ms-n3 me-1" title="Show aside menu">
                        <div class="btn btn-icon btn-active-color-white" id="kt_aside_mobile_toggle">
                            <i class="bi bi-list fs-1"></i>
                        </div>
                    </div>
                    <!--end::Aside mobile toggle-->
                    <!--begin::Mobile logo-->
                    <div class="d-flex align-items-center flex-grow-1 flex-lg-grow-0">
                        <a href="/" class="d-lg-none">
                            <img alt="Logo" src="assets/media/logos/pilar-text3.svg" class="h-25px"/>
                        </a>
                    </div>
                    <!--end::Mobile logo-->
                    <%- include('../../components/top-navbar.ejs', UserInfo) %>
                </div>
                <!--end::Container-->
            </div>
            <!--end::Header-->
            <!--begin::Content-->
            <div class="content d-flex flex-column flex-column-fluid" id="kt_content">
                <div class="d-flex flex-column-fluid">
                    <div class="container">
                        <div class="card" id="fac">
                            <div class="card-header pt-10">
                                <div class="mw-lg-950px mx-auto w-100">
                                    <div class="d-flex justify-content-between flex column flex-sm-row mb-10">
                                        <h4 class="fw-bolder text-gray-800 fs-2qx pe-1 pb-7">
                                            <%- doc.coddocumento == 10 ? 'Comprobante de Pago' : 'Documento Tributario Electrónico' %>
                                            <%- badge_status(doc._estado) %>
                                        </h4>
                                        <div class="text-sm-end">
                                            <div class="text-sm-end fw-semibold fs-4 text-muted mt-7">
                                                <div><%= doc.EMISORNOMBRECOMERCIAL %></div>
                                                <div><%= doc.EMISORNOMBRE %></div>
                                                <div>NIT: <%= doc.EMISORNIT %></div>
                                                <div><%= doc.EMISORDIRECCION %></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="pb-5">
                                    <div class="d-flex flex-column gap-7 gap-md-10">
                                        <div class="flex-root d-flex flex-column">
                                            <div class="fw-bold fs-2">
                                                <span class="fs-5 text-muted">Cliente: </span><span
                                                        class="fs-6"><%- doc.STRNOMBRESER %></span><br>
                                                <span class="fs-5 text-muted">Dirección: </span><span
                                                        class="fs-6"><%- doc.STRDIRSERVICIO %></span><br>
                                                <span class="fs-5 text-muted">Nit: </span><span
                                                        class="fs-6"><%- doc.STRNIT %></span>
                                            </div>
                                        </div>
                                        <div class="separator"></div>
                                        <div class="d-flex flex-column flex-sm-row gap-7 gap-md-10 fw-bold">
                                            <div class="flex-root d-flex flex-column">
                                                <span class="text-muted fs-5">Fecha Emision</span>
                                                <span class="fs-6"><%- doc.FechaHoraEmision %></span>
                                            </div>
                                            <div class="flex-root d-flex flex-column">
                                                <span class="text-muted fs-5"># Operador</span>
                                                <span class="fs-6"><%- doc.codoperador %></span>
                                            </div>
                                            <div class="flex-root d-flex flex-column">
                                                <span class="text-muted fs-5"># Serial</span>
                                                <span class="fs-6"><%- doc.codserial %></span>
                                            </div>

                                        </div>
                                    </div>
                                    <% if (doc.coddocumento == 9) { %>
                                    <div class="d-flex flex-column flex-sm-row gap-7 gap-md-10 fw-bold pt-2">
                                        <div class="flex-root d-flex flex-column">
                                            <span class="text-muted fs-5">Número de Autorización</span>
                                            <span class="fs-6"><%- doc._uuid %></span>
                                        </div>
                                        <div class="flex-root d-flex flex-column">
                                            <span class="text-muted fs-5">Serie</span>
                                            <span class="fs-6"><%- doc._serie %></span>
                                        </div>
                                        <div class="flex-root d-flex flex-column">
                                            <span class="text-muted fs-5">Número</span>
                                            <span class="fs-6"><%- doc._numero %></span>
                                        </div>
                                    </div>
                                    <% } %>
                                    <div class="d-flex justify-content-between flex-column">
                                        <div class="table-responsive border-bottom mb-9">
                                            <table class="table align-middle table-row-dashed  mb-0 border">
                                                <thead class="bg-light">
                                                <tr class="border-bottom fs-5 fw-bold text-muted">
                                                    <th class="pb-2">Descripción</th>
                                                    <th class="text-end pb-2">Costo</th>
                                                    <th class="text-end pb-2">Impuesto</th>
                                                    <th class="text-end pb-2">Total</th>
                                                </tr>
                                                </thead>
                                                <tbody class="fw-semibold text-gray-600">
                                                <% doc.detail.forEach(row => { %>
                                                    <tr>
                                                        <td class="fw-bold "><%- row.strdescripcion %></td>
                                                        <td class="text-end  pb-2"><%- row.mntgravable %></td>
                                                        <td class="text-end  pb-2"><%- row.mntimpuesto %></td>
                                                        <td class="text-end  pb-2"><%- row.total %></td>
                                                    </tr>
                                                <% }) %>
                                                <tr>
                                                    <td class="fs-3 text-dark fw-bolder text-end">TOTALES</td>
                                                    <td class="text-dark fs-3 fw-bolder text-end"><%- doc.TOTGRAVABLE %></td>
                                                    <td class="text-dark fs-3 fw-bolder text-end"><%- doc.TOTIMPUESTO %></td>
                                                    <td class="text-dark fs-3 fw-bolder text-end"><%- doc.TOTCANTIDAD %></td>
                                                </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                        <% if (doc.coddocumento == 9) { %>
                                        <br>
                                        <%- doc.EMISORNIT == '3563626' ? '* Sujeto a pagos trimestrales' : '* Sujeto a retención definitiva ISR' %>
                                        <br>
                                        <div class="d-flex justify-content-between flex-column flex-sm-row mb-19">
                                            <table class="table border ">
                                                <thead class="bg-light">
                                                <tr>
                                                    <th class="text-center">Datos del certificador</th>
                                                </tr>
                                                </thead>
                                                <tbody>
                                                <tr>
                                                    <td class="text-center">INFILE S. A. NIT: 12521337</td>
                                                </tr>
                                                </tbody>
                                            </table>
                                            <div class="text-sm-end">
                                                <div id="qrcode" class="qrcode"></div>
                                            </div>
                                        </div>
                                        <% } %>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <br>
                        <div class="card">
                            <div class="card-body">
                                <% if (doc.coddocumento === 9) { %>
                                <button class="btn btn-primary" onclick="printDocument('fac')"><i
                                            class="fa fa-print"></i>IMPRIMIR
                                </button>
                                <% } %>
                                <% if (doc._estado !== 'RV') { %>
                                <button type="button" class="btn btn-danger" data-bs-toggle="modal"
                                        data-bs-target="#kt_modal_1">REVERSAR
                                </button>
                                <% } %>
                            </div>
                        </div>
                    </div>
                </div>

                <form method="delete" action="/cash/operations/documents/" id="frmdocumento">
                <div class="modal fade" tabindex="-1" id="kt_modal_1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h3 class="modal-title">Reversion de Comprobante</h3>
                                <!--begin::Close-->
                                <div class="btn btn-icon btn-sm btn-active-light-primary ms-2" data-bs-dismiss="modal"
                                     aria-label="Close">
                                    <span class="svg-icon svg-icon-1"></span>
                                </div>
                                <!--end::Close-->
                            </div>
                            <div class="modal-body">
                                <p>Describa el motivo de reversión del documento</p>
                                <textarea name="strmotivoanulacion"
                                          class="form-control form-control-solid"
                                          minlength="10"
                                          cols="3"
                                          onkeyup="removeCharacters()"
                                          required></textarea>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-light" data-bs-dismiss="modal">CERRAR</button>
                                <button type="submit" class="btn btn-danger" >REVERSAR</button>
                            </div>
                        </div>
                    </div>
                </div>
                </form>

            </div>
            <!--end::Content-->
            <%- include('../../components/bottom-footer.ejs') %>
        </div>
        <!--end::Wrapper-->
    </div>
    <!--end::Page-->
</div>
<!--end::Root-->
<!-- modal -->

<!-- end modal -->
<%- include('../../components/kt-scrolltop') %>
<!--end::Main-->
<%- include('../../components/web-footer') %>
<!--begin::Page Custom Javascript(used by this page)-->
<script src="assets/js/custom/widgets.js"></script>
<script src="https://cdn.rawgit.com/davidshimjs/qrcodejs/gh-pages/qrcode.min.js"></script>
<!--end::Page Custom Javascript-->

<script>
    "use strict";
    var info_dte = JSON.parse('<%- JSON.stringify(doc) %>');
    const url = `${window.location.origin}/api`;

    const sinDiacriticos = (function(){
        const de = 'ÁÃÀÄÂÉËÈÊÍÏÌÎÓÖÒÔÚÜÙÛÑÇáãàäâéëèêíïìîóöòôúüùûñç',
            a = 'AAAAAEEEEIIIIOOOOUUUUNCaaaaaeeeeiiiioooouuuunc',
            re = new RegExp('['+de+']' , 'ug');

        return texto =>
            texto.replace(
                re,
                match => a.charAt(de.indexOf(match))
            );
    })();

    function removeCharacters(){
        var x = document.getElementsByName('strmotivoanulacion')[0].value;
        x = sinDiacriticos(x)
        document.getElementsByName('strmotivoanulacion')[0].value = x.toUpperCase();
    }

    function printDocument(divname) {
        var element = document.getElementById(divname);
        var a = window.open('', '', 'height=800, width=600');
        a.document.write('<html>');
        a.document.write(`<head> <%- include('../../components/web-header') %> </head>`);
        a.document.write('<body>');
        a.document.write(element.innerHTML);
        a.document.write('</body></html>');
        a.print();
    }

    $("#frmdocumento").submit(function (e) {
        e.preventDefault();
        const form = $(this);
        const dataform = form.serializeArray();
        const url = form.attr('action');
        const method = form.attr('method');
        let data_ajax = [];
        data_ajax.push(dataform[0])
        for (var key in info_dte)
            data_ajax.push({name: key, value: info_dte[key]})


        $.ajax({
            url: url,
            type: method,
            data: data_ajax,
            success: function (data) {
                console.log('success', data);
                if (data.resultado) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Documento anulado exitosamente!',
                        text: data.descripcion,
                        confirmButtonColor: '#3085d6',
                        confirmButtonText: 'Aceptar'
                    }).then((result) => {
                        if (result.value) {
                            window.location.reload();
                        }
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error!',
                        text: data.descripcion,
                        confirmButtonColor: '#3085d6',
                        confirmButtonText: 'Aceptar'
                    });
                }
            }
        });
    });
    $(document).ready(() => {

        if (info_dte.coddocumento == 9 ){
            const numero = '<%= doc._uuid %>';
            const emisor = '<%= doc.EMISORNIT %>';
            const receptor = '<%= doc.STRNIT %>';
            const monto = '<%= doc.TOTCANTIDAD %>';

            const url = `https://felpub.c.sat.gob.gt/verificador-web/publico/vistas/verificacionDte.jsf?tipo=autorizacion&numero=${numero}&emisor=${emisor}&receptor=${receptor}&monto=${monto}`;

            let qrcodeContainer = document.getElementById("qrcode");
            qrcodeContainer.innerHTML = "";
            new QRCode(qrcodeContainer, {
                text: url,
                width: 128,
                height: 128,
                colorDark: "#000000",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.H
            });
        }



    })

    function reversardoc() {
        const url_reversa = `${window.location.origin}/cash/operations/documents`;

        const data = {
            uuid: '<%= doc._uuid %>',
            codserial: '<%- doc.codserial %>',
            strnitemisor: '<%= doc.EMISORNIT %>',
            strnitreceptor: '<%= doc.STRNIT %>',
            strfechahoraemision: '<%- doc.FechaHoraEmision %>',
            strmotivoanulacion: document.getElementById('')
        }

    }
</script>
<!--end::Page Custom Javascript-->
<!--end::Javascript-->
</body>
<!--end::Body-->
</html>